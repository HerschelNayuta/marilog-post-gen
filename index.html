
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Posts Instagram - Marilog Transportes</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- html-to-image -->
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>

    <!-- JSZip -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <!-- FileSaver -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        /* Configuração Tailwind customizada */
        @layer base {
            * {
                font-family: 'Roboto', sans-serif;
            }

            h1, h2, h3, h4, h5, h6, .font-title {
                font-family: 'Montserrat', sans-serif;
            }
        }

        /* Cores personalizadas Marilog */
        :root {
            --marilog-navy: #0D1B2A;
            --marilog-green: #66CC33;
            --marilog-gray: #B0B3B5;
            --marilog-white: #FFFFFF;
        }

        body {
            background: linear-gradient(135deg, #0D1B2A 0%, #1a2f42 100%);
            min-height: 100vh;
        }

        /* Preview Canvas */
        .preview-canvas {
            background: white;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Aspect ratios para Instagram */
        .aspect-story { aspect-ratio: 9 / 16; }
        .aspect-post { aspect-ratio: 4 / 5; }
        .aspect-square { aspect-ratio: 1 / 1; }

        /* Loading animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success { background: #66CC33; }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }

        /* Scrollbar customizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a2f42;
        }

        ::-webkit-scrollbar-thumb {
            background: #66CC33;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #55bb22;
        }

        /* Input estilizado */
        .input-marilog {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(102, 204, 51, 0.3);
            color: white;
            border-radius: 6px;
            padding: 10px 12px;
            transition: all 0.3s;
        }

        .input-marilog:focus {
            outline: none;
            border-color: #66CC33;
            background: rgba(255,255,255,0.1);
        }

        .input-marilog::placeholder {
            color: rgba(255,255,255,0.4);
        }

        /* Button Marilog */
        .btn-marilog {
            background: #66CC33;
            color: #0D1B2A;
            font-weight: 700;
            padding: 12px 24px;
            border-radius: 6px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-marilog:hover {
            background: #55bb22;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 204, 51, 0.4);
        }

        .btn-marilog:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(176, 179, 181, 0.2);
            color: #B0B3B5;
            border: 1px solid #B0B3B5;
        }

        .btn-secondary:hover {
            background: rgba(176, 179, 181, 0.3);
            color: white;
        }

        /* Accordion */
        .accordion-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .accordion-header {
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .accordion-header:hover {
            background: rgba(102, 204, 51, 0.1);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .accordion-content.active {
            max-height: 2000px;
            padding: 16px;
        }

        /* Template cards */
        .template-card {
            background: rgba(255,255,255,0.08);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-card:hover {
            border-color: #66CC33;
            transform: scale(1.05);
        }

        .template-card.active {
            border-color: #66CC33;
            background: rgba(102, 204, 51, 0.15);
        }

        /* Icon picker modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #1a2f42;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .icon-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 24px;
            color: #66CC33;
        }

        .icon-item:hover {
            border-color: #66CC33;
            background: rgba(102, 204, 51, 0.15);
            transform: scale(1.1);
        }

        /* Pattern backgrounds */
        .pattern-diagonal {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(102, 204, 51, 0.1) 10px,
                rgba(102, 204, 51, 0.1) 20px
            );
        }

        .pattern-dots {
            background-image: radial-gradient(circle, rgba(102, 204, 51, 0.15) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .pattern-grid {
            background-image: 
                linear-gradient(rgba(102, 204, 51, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(102, 204, 51, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Slide editor */
        .slide-item {
            background: rgba(255,255,255,0.05);
            border-left: 4px solid #66CC33;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        /* Color picker presets */
        .color-preset {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .color-preset:hover {
            border-color: white;
            transform: scale(1.1);
        }

        .color-preset.active {
            border-color: #66CC33;
        }
    </style>
</head>

<body class="text-white">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Modal de Ícones -->
    <div id="icon-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-title font-bold text-white">Escolher Ícone</h3>
                <button onclick="closeIconModal()" class="text-3xl text-gray-400 hover:text-white transition">&times;</button>
            </div>

            <input type="text" id="icon-search" placeholder="Pesquisar ícone..." 
                   class="input-marilog w-full mb-4" onkeyup="filterIcons()">

            <div id="icon-grid" class="icon-grid">
                <!-- Icons serão inseridos via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-opacity-20 bg-black backdrop-blur-md border-b border-green-500/30">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://i.ibb.co/bjPby0sw/Logo-Branca.png" alt="Marilog" class="h-12">
                <div>
                    <h1 class="text-2xl font-title font-bold">Gerador de Posts Instagram</h1>
                    <p class="text-sm text-green-400">Marilog Transportes e Logística</p>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="saveProject()" class="btn-secondary px-4 py-2 rounded-lg flex items-center gap-2">
                    <i class="fas fa-save"></i>
                    <span class="hidden md:inline">Salvar</span>
                </button>
                <button onclick="loadProject()" class="btn-secondary px-4 py-2 rounded-lg flex items-center gap-2">
                    <i class="fas fa-folder-open"></i>
                    <span class="hidden md:inline">Carregar</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

            <!-- Painel de Edição (Esquerda) -->
            <div class="lg:col-span-2 space-y-4">

                <!-- Configurações Gerais -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-cog text-green-400"></i>
                            <span class="font-title font-bold">Configurações Gerais</span>
                        </div>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </div>
                    <div class="accordion-content active">

                        <!-- Formato -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">Formato</label>
                            <select id="post-format" onchange="changeFormat()" class="input-marilog w-full">
                                <option value="square">Carrossel (1080×1080)</option>
                                <option value="post">Post Único (1080×1350)</option>
                            </select>
                        </div>

                        <!-- Logo Upload -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">Logo</label>
                            <input type="file" id="logo-upload" accept="image/*" 
                                   onchange="handleLogoUpload()" class="input-marilog w-full text-sm">
                            <p class="text-xs text-gray-400 mt-1">Ou use a logo padrão Marilog</p>
                        </div>

                        <!-- Cor de Fundo -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">Cor de Fundo</label>
                            <div class="flex gap-2 mb-2">
                                <div class="color-preset active" style="background: #0D1B2A;" 
                                     onclick="selectColor('#0D1B2A', this)"></div>
                                <div class="color-preset" style="background: #66CC33;" 
                                     onclick="selectColor('#66CC33', this)"></div>
                                <div class="color-preset" style="background: #B0B3B5;" 
                                     onclick="selectColor('#B0B3B5', this)"></div>
                                <div class="color-preset" style="background: #FFFFFF;" 
                                     onclick="selectColor('#FFFFFF', this)"></div>
                                <input type="color" id="bg-color" value="#0D1B2A" 
                                       onchange="selectColor(this.value)" class="w-10 h-10 rounded-full cursor-pointer">
                            </div>
                        </div>

                        <!-- Padrão de Fundo -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">Padrão</label>
                            <select id="bg-pattern" onchange="updatePreview()" class="input-marilog w-full">
                                <option value="none">Nenhum</option>
                                <option value="diagonal">Linhas Diagonais</option>
                                <option value="dots">Pontos</option>
                                <option value="grid">Grade</option>
                            </select>
                        </div>

                        <!-- Background Image -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">Imagem de Fundo (Opcional)</label>
                            <input type="file" id="bg-image-upload" accept="image/*" 
                                   onchange="handleBgImageUpload()" class="input-marilog w-full text-sm">
                            <div class="mt-2">
                                <label class="block text-xs text-gray-400 mb-1">Opacidade da Sobreposição</label>
                                <input type="range" id="overlay-opacity" min="0" max="100" value="70" 
                                       onchange="updatePreview()" class="w-full">
                            </div>
                        </div>

                    </div>
                </div>

                <!-- IA Gemini -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-brain text-purple-400"></i>
                            <span class="font-title font-bold">Gerar com IA (Gemini)</span>
                        </div>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </div>
                    <div class="accordion-content">

                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">API Key do Gemini</label>
                            <input type="password" id="gemini-api-key" placeholder="Cole sua API key aqui" 
                                   class="input-marilog w-full" value="">
                            <p class="text-xs text-gray-400 mt-1">
                                <a href="https://makersuite.google.com/app/apikey" target="_blank" 
                                   class="text-green-400 hover:underline">
                                    Obter API Key gratuita
                                </a>
                            </p>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">Tema do Post</label>
                            <textarea id="ai-theme" rows="3" placeholder="Ex: 3 erros críticos na logística que prejudicam o lucro" 
                                      class="input-marilog w-full"></textarea>
                        </div>

                        <button onclick="generateWithAI()" class="btn-marilog w-full flex items-center justify-center gap-2">
                            <i class="fas fa-magic"></i>
                            <span>Gerar Conteúdo com IA</span>
                        </button>

                        <div id="ai-loading" class="hidden mt-4 text-center">
                            <div class="inline-block animate-spin-slow text-green-400 text-3xl">
                                <i class="fas fa-circle-notch"></i>
                            </div>
                            <p class="text-sm mt-2">Gerando conteúdo...</p>
                        </div>

                    </div>
                </div>

                <!-- Slides -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-images text-blue-400"></i>
                            <span class="font-title font-bold">Slides (<span id="slide-count">1</span>)</span>
                        </div>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </div>
                    <div class="accordion-content active">

                        <div id="slides-container">
                            <!-- Slides serão inseridos aqui via JavaScript -->
                        </div>

                        <button onclick="addSlide()" class="btn-secondary w-full mt-4 flex items-center justify-center gap-2">
                            <i class="fas fa-plus"></i>
                            <span>Adicionar Slide</span>
                        </button>

                    </div>
                </div>

                <!-- Exportar -->
                <div class="accordion-item">
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-download text-green-400"></i>
                            <span class="font-title font-bold">Exportar</span>
                        </div>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </div>
                    <div class="accordion-content active">

                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">Nome do Arquivo</label>
                            <input type="text" id="export-filename" placeholder="marilog_post" 
                                   class="input-marilog w-full" value="marilog_post">
                        </div>

                        <button onclick="downloadImages()" class="btn-marilog w-full flex items-center justify-center gap-2 mb-3">
                            <i class="fas fa-image"></i>
                            <span>Baixar PNG</span>
                        </button>

                        <button onclick="downloadCarousel()" class="btn-secondary w-full flex items-center justify-center gap-2">
                            <i class="fas fa-file-zipper"></i>
                            <span>Baixar Carrossel (ZIP)</span>
                        </button>

                        <div id="export-loading" class="hidden mt-4 text-center">
                            <div class="inline-block animate-spin text-green-400 text-3xl">
                                <i class="fas fa-circle-notch"></i>
                            </div>
                            <p class="text-sm mt-2">Exportando...</p>
                        </div>

                    </div>
                </div>

            </div>

            <!-- Preview (Direita) -->
            <div class="lg:col-span-3">
                <div class="sticky top-4">
                    <div class="bg-opacity-20 bg-black backdrop-blur-md rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-title font-bold">Preview</h2>
                            <div class="flex gap-2">
                                <button onclick="zoomOut()" class="btn-secondary px-3 py-1 text-sm">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <button onclick="zoomReset()" class="btn-secondary px-3 py-1 text-sm">
                                    100%
                                </button>
                                <button onclick="zoomIn()" class="btn-secondary px-3 py-1 text-sm">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Preview Canvas -->
                        <div id="preview-wrapper" class="overflow-auto max-h-[80vh] flex justify-center">
                            <div id="preview-container" style="transform: scale(1); transform-origin: top center;">
                                <!-- O preview será renderizado aqui -->
                            </div>
                        </div>

                        <div class="mt-4 text-center text-sm text-gray-400">
                            <p>Arraste os slides para reordenar | Clique para editar</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-opacity-20 bg-black backdrop-blur-md border-t border-green-500/30 mt-12 py-6">
        <div class="container mx-auto px-4 text-center text-sm text-gray-400">
            <p>© 2026 Marilog Transportes e Logística | Gerador de Posts Instagram v1.0</p>
            <p class="mt-2">
                <a href="https://www.marilog.com.br" target="_blank" class="text-green-400 hover:underline">www.marilog.com.br</a>
                | 
                <a href="tel:+5547992177018" class="text-green-400 hover:underline">(47) 99217-7018</a>
            </p>
        </div>
    </footer>

<script>
// ============================================
// VARIÁVEIS GLOBAIS
// ============================================
let slides = [{
    id: 1,
    template: 'capa',
    title: 'BEM-VINDO',
    subtitle: 'Marilog Transportes',
    body: 'Logística que não para',
    badge: '',
    icon: 'fa-truck-fast',
    number: '',
    bgColor: '#0D1B2A',
    textColor: '#FFFFFF'
}];

let currentSlideId = 1;
let logoUrl = 'https://i.ibb.co/bjPby0sw/Logo-Branca.png';
let bgImageUrl = '';
let zoomLevel = 1;

// Ícones disponíveis do FontAwesome
const availableIcons = [
    'fa-truck-fast', 'fa-truck', 'fa-box', 'fa-boxes-stacked', 
    'fa-location-dot', 'fa-map-marker-alt', 'fa-route', 'fa-map',
    'fa-clock', 'fa-calendar', 'fa-calendar-check',
    'fa-check', 'fa-check-circle', 'fa-check-double',
    'fa-times', 'fa-times-circle', 'fa-exclamation-triangle',
    'fa-arrow-right', 'fa-arrow-up', 'fa-arrow-down', 'fa-arrows-alt',
    'fa-shield', 'fa-shield-alt', 'fa-lock', 'fa-key',
    'fa-phone', 'fa-envelope', 'fa-whatsapp', 'fa-instagram',
    'fa-user', 'fa-users', 'fa-user-tie', 'fa-handshake',
    'fa-chart-line', 'fa-chart-bar', 'fa-chart-pie',
    'fa-lightbulb', 'fa-star', 'fa-heart', 'fa-thumbs-up',
    'fa-cog', 'fa-wrench', 'fa-tools', 'fa-hammer',
    'fa-warehouse', 'fa-industry', 'fa-building',
    'fa-dollar-sign', 'fa-coins', 'fa-money-bill-wave',
    'fa-medal', 'fa-trophy', 'fa-award',
    'fa-globe', 'fa-earth-americas', 'fa-paper-plane'
];

// ============================================
// FUNÇÕES UTILITÁRIAS
// ============================================

// Toast notifications
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>${message}`;
    document.getElementById('toast-container').appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Debounce para otimizar performance
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Gerar ID único
function generateId() {
    return Date.now() + Math.random();
}

// Accordion
function toggleAccordion(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.fa-chevron-down');

    content.classList.toggle('active');
    icon.style.transform = content.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0)';
}

// Seletor de cor
function selectColor(color, element) {
    document.getElementById('bg-color').value = color;

    // Atualizar presets ativos
    document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('active'));
    if (element) {
        element.classList.add('active');
    }

    updatePreview();
}

// Zoom controls
function zoomIn() {
    zoomLevel = Math.min(zoomLevel + 0.1, 2);
    document.getElementById('preview-container').style.transform = `scale(${zoomLevel})`;
}

function zoomOut() {
    zoomLevel = Math.max(zoomLevel - 0.1, 0.5);
    document.getElementById('preview-container').style.transform = `scale(${zoomLevel})`;
}

function zoomReset() {
    zoomLevel = 1;
    document.getElementById('preview-container').style.transform = 'scale(1)';
}

// Upload de logo
function handleLogoUpload() {
    const file = document.getElementById('logo-upload').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            logoUrl = e.target.result;
            updatePreview();
            showToast('Logo carregada com sucesso!');
        };
        reader.readAsDataURL(file);
    }
}

// Upload de imagem de fundo
function handleBgImageUpload() {
    const file = document.getElementById('bg-image-upload').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            bgImageUrl = e.target.result;
            updatePreview();
            showToast('Imagem de fundo carregada!');
        };
        reader.readAsDataURL(file);
    }
}

// Mudar formato
function changeFormat() {
    updatePreview();
}

// ============================================
// GERENCIAMENTO DE SLIDES
// ============================================

function addSlide(data = null) {
    const newSlide = data || {
        id: generateId(),
        template: 'checklist',
        title: 'Novo Slide',
        subtitle: '',
        body: 'Edite o conteúdo aqui',
        badge: '',
        icon: 'fa-check',
        number: '',
        bgColor: '#0D1B2A',
        textColor: '#FFFFFF'
    };

    slides.push(newSlide);
    renderSlidesEditor();
    updatePreview();
    showToast('Slide adicionado!');
}

function removeSlide(id) {
    if (slides.length === 1) {
        showToast('Você precisa ter pelo menos 1 slide!', 'error');
        return;
    }

    slides = slides.filter(s => s.id !== id);
    renderSlidesEditor();
    updatePreview();
    showToast('Slide removido!');
}

function duplicateSlide(id) {
    const slide = slides.find(s => s.id === id);
    if (slide) {
        const newSlide = { ...slide, id: generateId() };
        const index = slides.findIndex(s => s.id === id);
        slides.splice(index + 1, 0, newSlide);
        renderSlidesEditor();
        updatePreview();
        showToast('Slide duplicado!');
    }
}

function moveSlide(id, direction) {
    const index = slides.findIndex(s => s.id === id);
    if (direction === 'up' && index > 0) {
        [slides[index], slides[index - 1]] = [slides[index - 1], slides[index]];
    } else if (direction === 'down' && index < slides.length - 1) {
        [slides[index], slides[index + 1]] = [slides[index + 1], slides[index]];
    }
    renderSlidesEditor();
    updatePreview();
}

function updateSlide(id, field, value) {
    const slide = slides.find(s => s.id === id);
    if (slide) {
        slide[field] = value;
        updatePreview();
    }
}

// ============================================
// MODAL DE ÍCONES
// ============================================

let currentIconTarget = null;

function openIconModal(slideId) {
    currentIconTarget = slideId;
    const modal = document.getElementById('icon-modal');
    modal.classList.add('active');

    // Renderizar ícones
    const grid = document.getElementById('icon-grid');
    grid.innerHTML = availableIcons.map(icon => `
        <div class="icon-item" onclick="selectIcon('${icon}')" data-icon="${icon}">
            <i class="fas ${icon}"></i>
        </div>
    `).join('');
}

function closeIconModal() {
    document.getElementById('icon-modal').classList.remove('active');
    currentIconTarget = null;
}

function selectIcon(icon) {
    if (currentIconTarget) {
        updateSlide(currentIconTarget, 'icon', icon);
        document.querySelector(`#slide-${currentIconTarget} .icon-preview`).innerHTML = `<i class="fas ${icon}"></i>`;
    }
    closeIconModal();
}

function filterIcons() {
    const search = document.getElementById('icon-search').value.toLowerCase();
    document.querySelectorAll('.icon-item').forEach(item => {
        const icon = item.dataset.icon.toLowerCase();
        item.style.display = icon.includes(search) ? 'flex' : 'none';
    });
}

// ============================================
// SALVAR/CARREGAR PROJETO
// ============================================

function saveProject() {
    const project = {
        slides,
        logoUrl,
        bgImageUrl,
        format: document.getElementById('post-format').value,
        bgColor: document.getElementById('bg-color').value,
        bgPattern: document.getElementById('bg-pattern').value,
        overlayOpacity: document.getElementById('overlay-opacity').value,
        apiKey: document.getElementById('gemini-api-key').value
    };

    localStorage.setItem('marilog_project', JSON.stringify(project));
    showToast('Projeto salvo com sucesso!');
}

function loadProject() {
    const saved = localStorage.getItem('marilog_project');
    if (saved) {
        const project = JSON.parse(saved);
        slides = project.slides;
        logoUrl = project.logoUrl;
        bgImageUrl = project.bgImageUrl;

        document.getElementById('post-format').value = project.format;
        document.getElementById('bg-color').value = project.bgColor;
        document.getElementById('bg-pattern').value = project.bgPattern;
        document.getElementById('overlay-opacity').value = project.overlayOpacity;
        document.getElementById('gemini-api-key').value = project.apiKey || '';

        renderSlidesEditor();
        updatePreview();
        showToast('Projeto carregado!');
    } else {
        showToast('Nenhum projeto salvo encontrado', 'error');
    }
}

console.log('✅ JavaScript Parte 1 carregado');
</script>

<script>
// ============================================
// RENDERIZAR EDITOR DE SLIDES
// ============================================

function renderSlidesEditor() {
    const container = document.getElementById('slides-container');
    document.getElementById('slide-count').textContent = slides.length;

    container.innerHTML = slides.map((slide, index) => `
        <div class="slide-item" id="slide-${slide.id}">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <span class="font-bold text-green-400">Slide ${index + 1}</span>
                    <select onchange="updateSlide(${slide.id}, 'template', this.value)" 
                            class="input-marilog text-sm py-1 px-2">
                        <option value="capa" ${slide.template === 'capa' ? 'selected' : ''}>Capa</option>
                        <option value="erro" ${slide.template === 'erro' ? 'selected' : ''}>Erro/Problema</option>
                        <option value="checklist" ${slide.template === 'checklist' ? 'selected' : ''}>Checklist</option>
                        <option value="solucao" ${slide.template === 'solucao' ? 'selected' : ''}>Solução</option>
                        <option value="cta" ${slide.template === 'cta' ? 'selected' : ''}>CTA</option>
                        <option value="quote" ${slide.template === 'quote' ? 'selected' : ''}>Frase</option>
                    </select>
                </div>

                <div class="flex gap-1">
                    ${index > 0 ? `<button onclick="moveSlide(${slide.id}, 'up')" 
                        class="text-gray-400 hover:text-green-400 px-2 py-1">
                        <i class="fas fa-arrow-up"></i>
                    </button>` : ''}

                    ${index < slides.length - 1 ? `<button onclick="moveSlide(${slide.id}, 'down')" 
                        class="text-gray-400 hover:text-green-400 px-2 py-1">
                        <i class="fas fa-arrow-down"></i>
                    </button>` : ''}

                    <button onclick="duplicateSlide(${slide.id})" 
                        class="text-gray-400 hover:text-blue-400 px-2 py-1">
                        <i class="fas fa-copy"></i>
                    </button>

                    <button onclick="removeSlide(${slide.id})" 
                        class="text-gray-400 hover:text-red-400 px-2 py-1">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="space-y-2">
                <input type="text" placeholder="Título" value="${slide.title}" 
                       oninput="updateSlide(${slide.id}, 'title', this.value)"
                       class="input-marilog w-full text-sm">

                ${slide.template !== 'quote' ? `
                    <input type="text" placeholder="Subtítulo (opcional)" value="${slide.subtitle}" 
                           oninput="updateSlide(${slide.id}, 'subtitle', this.value)"
                           class="input-marilog w-full text-sm">
                ` : ''}

                <textarea placeholder="Texto do corpo" rows="2"
                          oninput="updateSlide(${slide.id}, 'body', this.value)"
                          class="input-marilog w-full text-sm">${slide.body}</textarea>

                ${['capa', 'checklist'].includes(slide.template) ? `
                    <input type="text" placeholder="Badge/Etiqueta (opcional)" value="${slide.badge}" 
                           oninput="updateSlide(${slide.id}, 'badge', this.value)"
                           class="input-marilog w-full text-sm">
                ` : ''}

                ${['erro', 'checklist', 'solucao'].includes(slide.template) ? `
                    <div class="flex gap-2">
                        <input type="text" placeholder="Número" value="${slide.number}" 
                               oninput="updateSlide(${slide.id}, 'number', this.value)"
                               class="input-marilog w-20 text-sm">

                        <button onclick="openIconModal(${slide.id})" 
                                class="btn-secondary flex-1 flex items-center justify-center gap-2 py-2">
                            <span class="icon-preview"><i class="fas ${slide.icon}"></i></span>
                            <span class="text-xs">Ícone</span>
                        </button>
                    </div>
                ` : ''}
            </div>
        </div>
    `).join('');
}

// ============================================
// TEMPLATES DE SLIDES
// ============================================

function getTemplate(slide, bgColor, bgPattern, format) {
    const isSquare = format === 'square';
    const width = 1080;
    const height = isSquare ? 1080 : 1350;

    // Cor de texto dinâmica baseada no fundo
    const isDark = isColorDark(bgColor);
    const textColor = isDark ? '#FFFFFF' : '#0D1B2A';
    const accentColor = '#66CC33';

    // Background image overlay
    const bgImageStyle = bgImageUrl ? `
        background-image: url('${bgImageUrl}');
        background-size: cover;
        background-position: center;
    ` : '';

    const overlayOpacity = document.getElementById('overlay-opacity').value / 100;

    // Pattern class
    const patternClass = bgPattern !== 'none' ? `pattern-${bgPattern}` : '';

    // Base styles
    const baseStyles = `
        width: ${width}px;
        height: ${height}px;
        background-color: ${bgColor};
        color: ${textColor};
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 60px;
        box-sizing: border-box;
    `;

    // Templates específicos
    switch(slide.template) {
        case 'capa':
            return `
                <div style="${baseStyles}" class="${patternClass}">
                    ${bgImageUrl ? `<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; ${bgImageStyle} opacity: 0.3;"></div>` : ''}
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: ${bgColor}; opacity: ${overlayOpacity};"></div>

                    <div style="position: relative; z-index: 10; text-align: center; width: 100%;">
                        ${logoUrl ? `<img src="${logoUrl}" style="height: 80px; margin: 0 auto 40px;">` : ''}

                        ${slide.badge ? `
                            <div style="display: inline-block; background: ${accentColor}; color: #0D1B2A; 
                                        padding: 8px 20px; border-radius: 20px; font-weight: 700; 
                                        font-size: 14px; margin-bottom: 30px;">
                                ${slide.badge}
                            </div>
                        ` : ''}

                        ${slide.number ? `
                            <div style="font-family: 'Montserrat', sans-serif; font-weight: 900; 
                                        font-size: 180px; line-height: 1; color: ${accentColor}; 
                                        text-shadow: 0 4px 20px rgba(102, 204, 51, 0.3);">
                                ${slide.number}
                            </div>
                        ` : ''}

                        <h1 style="font-family: 'Montserrat', sans-serif; font-weight: 800; 
                                   font-size: 64px; line-height: 1.1; margin: 30px 0;">
                            ${slide.title.toUpperCase()}
                        </h1>

                        ${slide.subtitle ? `
                            <p style="font-family: 'Roboto', sans-serif; font-size: 28px; 
                                      color: ${accentColor}; margin-top: 20px; font-weight: 500;">
                                ${slide.subtitle}
                            </p>
                        ` : ''}

                        ${slide.body ? `
                            <p style="font-family: 'Roboto', sans-serif; font-size: 22px; 
                                      margin-top: 30px; line-height: 1.5; opacity: 0.9;">
                                ${slide.body}
                            </p>
                        ` : ''}
                    </div>
                </div>
            `;

        case 'erro':
            return `
                <div style="${baseStyles}" class="${patternClass}">
                    ${bgImageUrl ? `<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; ${bgImageStyle} opacity: 0.2;"></div>` : ''}

                    ${slide.number ? `
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                    font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 400px; 
                                    color: rgba(102, 204, 51, 0.1); z-index: 1; line-height: 1;">
                            ${slide.number}
                        </div>
                    ` : ''}

                    <div style="position: relative; z-index: 10; width: 100%; max-width: 900px;">
                        ${logoUrl ? `<img src="${logoUrl}" style="height: 60px; margin-bottom: 40px;">` : ''}

                        <div style="display: flex; align-items: center; gap: 30px; margin-bottom: 30px;">
                            ${slide.number ? `
                                <div style="background: ${accentColor}; color: #0D1B2A; width: 100px; height: 100px; 
                                            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                            font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 48px; 
                                            flex-shrink: 0; box-shadow: 0 8px 24px rgba(102, 204, 51, 0.4);">
                                    ${slide.number}
                                </div>
                            ` : ''}

                            <div>
                                <div style="background: rgba(255, 59, 48, 0.2); display: inline-block; 
                                            padding: 8px 16px; border-radius: 8px; margin-bottom: 15px;">
                                    <i class="fas ${slide.icon}" style="color: #ff3b30; font-size: 32px;"></i>
                                </div>

                                <h2 style="font-family: 'Montserrat', sans-serif; font-weight: 800; 
                                           font-size: 48px; line-height: 1.2; margin: 0;">
                                    ${slide.title}
                                </h2>
                            </div>
                        </div>

                        <p style="font-family: 'Roboto', sans-serif; font-size: 28px; 
                                  line-height: 1.6; margin-left: 130px;">
                            ${slide.body}
                        </p>
                    </div>
                </div>
            `;

        case 'checklist':
            return `
                <div style="${baseStyles}" class="${patternClass}">
                    ${bgImageUrl ? `<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; ${bgImageStyle} opacity: 0.15;"></div>` : ''}

                    ${slide.number ? `
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                    font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 400px; 
                                    color: rgba(102, 204, 51, 0.1); z-index: 1; line-height: 1;">
                            ${slide.number}
                        </div>
                    ` : ''}

                    <div style="position: relative; z-index: 10; width: 100%; max-width: 900px; text-align: center;">
                        ${logoUrl ? `<img src="${logoUrl}" style="height: 60px; margin-bottom: 40px;">` : ''}

                        ${slide.badge ? `
                            <div style="display: inline-block; background: ${accentColor}; color: #0D1B2A; 
                                        padding: 8px 20px; border-radius: 20px; font-weight: 700; 
                                        font-size: 16px; margin-bottom: 30px;">
                                ${slide.badge}
                            </div>
                        ` : ''}

                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 30px;">
                            <div style="background: ${accentColor}; color: #0D1B2A; width: 80px; height: 80px; 
                                        border-radius: 12px; display: flex; align-items: center; justify-content: center; 
                                        box-shadow: 0 8px 24px rgba(102, 204, 51, 0.4);">
                                <i class="fas fa-check" style="font-size: 48px;"></i>
                            </div>

                            <i class="fas ${slide.icon}" style="font-size: 64px; color: ${accentColor};"></i>
                        </div>

                        <h2 style="font-family: 'Montserrat', sans-serif; font-weight: 800; 
                                   font-size: 52px; line-height: 1.2; margin: 0 0 30px 0;">
                            ${slide.title}
                        </h2>

                        <p style="font-family: 'Roboto', sans-serif; font-size: 28px; 
                                  line-height: 1.6;">
                            ${slide.body}
                        </p>
                    </div>
                </div>
            `;

        case 'solucao':
            return `
                <div style="${baseStyles} background: linear-gradient(135deg, ${bgColor} 0%, ${accentColor} 100%);" class="${patternClass}">
                    ${bgImageUrl ? `<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; ${bgImageStyle} opacity: 0.2;"></div>` : ''}

                    <div style="position: relative; z-index: 10; width: 100%; max-width: 900px; text-align: center;">
                        ${logoUrl ? `<img src="${logoUrl}" style="height: 70px; margin-bottom: 40px;">` : ''}

                        <div style="background: rgba(255, 255, 255, 0.95); color: #0D1B2A; 
                                    padding: 60px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <div style="background: ${accentColor}; width: 120px; height: 120px; 
                                        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                        margin: 0 auto 30px; box-shadow: 0 12px 32px rgba(102, 204, 51, 0.5);">
                                <i class="fas ${slide.icon}" style="font-size: 64px; color: #0D1B2A;"></i>
                            </div>

                            <h2 style="font-family: 'Montserrat', sans-serif; font-weight: 800; 
                                       font-size: 56px; line-height: 1.2; margin: 0 0 30px 0; color: #0D1B2A;">
                                ${slide.title}
                            </h2>

                            ${slide.subtitle ? `
                                <p style="font-family: 'Roboto', sans-serif; font-size: 24px; 
                                          color: ${accentColor}; font-weight: 700; margin-bottom: 20px;">
                                    ${slide.subtitle}
                                </p>
                            ` : ''}

                            <p style="font-family: 'Roboto', sans-serif; font-size: 26px; 
                                      line-height: 1.6; color: #0D1B2A;">
                                ${slide.body}
                            </p>
                        </div>
                    </div>
                </div>
            `;

        case 'cta':
            return `
                <div style="${baseStyles}" class="${patternClass}">
                    ${bgImageUrl ? `<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; ${bgImageStyle} opacity: 0.25;"></div>` : ''}

                    <div style="position: relative; z-index: 10; width: 100%; max-width: 900px; text-align: center;">
                        ${logoUrl ? `<img src="${logoUrl}" style="height: 100px; margin-bottom: 50px;">` : ''}

                        <h2 style="font-family: 'Montserrat', sans-serif; font-weight: 900; 
                                   font-size: 64px; line-height: 1.1; margin: 0 0 40px 0;">
                            ${slide.title}
                        </h2>

                        ${slide.body ? `
                            <p style="font-family: 'Roboto', sans-serif; font-size: 28px; 
                                      line-height: 1.6; margin-bottom: 50px;">
                                ${slide.body}
                            </p>
                        ` : ''}

                        <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                            <div style="background: ${accentColor}; color: #0D1B2A; padding: 20px 50px; 
                                        border-radius: 12px; font-family: 'Montserrat', sans-serif; 
                                        font-weight: 700; font-size: 24px; box-shadow: 0 8px 24px rgba(102, 204, 51, 0.4);">
                                <i class="fas fa-globe mr-2"></i>
                                www.marilog.com.br
                            </div>

                            <div style="background: ${accentColor}; color: #0D1B2A; padding: 20px 50px; 
                                        border-radius: 12px; font-family: 'Montserrat', sans-serif; 
                                        font-weight: 700; font-size: 24px; box-shadow: 0 8px 24px rgba(102, 204, 51, 0.4);">
                                <i class="fas fa-phone mr-2"></i>
                                (47) 99217-7018
                            </div>
                        </div>
                    </div>
                </div>
            `;

        case 'quote':
            return `
                <div style="${baseStyles}" class="${patternClass}">
                    ${bgImageUrl ? `<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; ${bgImageStyle} opacity: 0.2;"></div>` : ''}

                    <div style="position: relative; z-index: 10; width: 100%; max-width: 900px; text-align: center;">
                        <i class="fas fa-quote-left" style="font-size: 80px; color: ${accentColor}; opacity: 0.3; margin-bottom: 40px;"></i>

                        <h2 style="font-family: 'Montserrat', sans-serif; font-weight: 700; 
                                   font-size: 52px; line-height: 1.4; margin: 0 0 40px 0; font-style: italic;">
                            "${slide.title}"
                        </h2>

                        ${slide.body ? `
                            <p style="font-family: 'Roboto', sans-serif; font-size: 24px; 
                                      color: ${accentColor}; font-weight: 600;">
                                — ${slide.body}
                            </p>
                        ` : ''}

                        ${logoUrl ? `<img src="${logoUrl}" style="height: 60px; margin-top: 50px;">` : ''}
                    </div>
                </div>
            `;

        default:
            return `<div style="${baseStyles}">Template não encontrado</div>`;
    }
}

// Verificar se cor é escura
function isColorDark(color) {
    const hex = color.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness < 128;
}

console.log('✅ JavaScript Parte 2 carregado (Templates)');
</script>

<script>
// ============================================
// ATUALIZAÇÃO DE PREVIEW
// ============================================

const updatePreview = debounce(() => {
    const container = document.getElementById('preview-container');
    const format = document.getElementById('post-format').value;
    const bgColor = document.getElementById('bg-color').value;
    const bgPattern = document.getElementById('bg-pattern').value;

    container.innerHTML = slides.map(slide => 
        getTemplate(slide, bgColor, bgPattern, format)
    ).join('<div style="height: 20px;"></div>');
}, 300);

// ============================================
// INTEGRAÇÃO GEMINI AI
// ============================================

async function generateWithAI() {
    const apiKey = document.getElementById('gemini-api-key').value.trim();
    const theme = document.getElementById('ai-theme').value.trim();

    if (!apiKey) {
        showToast('Por favor, insira sua API Key do Gemini', 'error');
        return;
    }

    if (!theme) {
        showToast('Por favor, descreva o tema do post', 'error');
        return;
    }

    // Salvar API key
    localStorage.setItem('gemini_api_key', apiKey);

    // Mostrar loading
    document.getElementById('ai-loading').classList.remove('hidden');

    try {
        const prompt = `Você é um especialista em marketing digital e criação de conteúdo para Instagram. 

Crie um carrossel para Instagram sobre o tema: "${theme}"

O carrossel é para a empresa Marilog Transportes e Logística, que atua nas regiões Sul e Sudeste do Brasil.

IMPORTANTE: Responda APENAS com um JSON válido, sem texto adicional antes ou depois. Use este formato EXATO:

{
  "slides": [
    {
      "template": "capa",
      "title": "TÍTULO DA CAPA",
      "subtitle": "Subtítulo opcional",
      "body": "Texto complementar",
      "badge": "ARRASTA PRO LADO",
      "icon": "fa-truck-fast",
      "number": "3"
    },
    {
      "template": "erro",
      "title": "Nome do Erro/Problema",
      "subtitle": "",
      "body": "Descrição detalhada do problema",
      "badge": "",
      "icon": "fa-exclamation-triangle",
      "number": "01"
    }
  ]
}

Templates disponíveis:
- "capa": Slide de capa/introdução (use number para número destacado)
- "erro": Problema/erro/desafio (use number para numeração)
- "checklist": Item de checklist com ícone de check
- "solucao": Slide de solução com destaque especial
- "cta": Call-to-action final com contatos
- "quote": Frase motivacional/citação

Ícones disponíveis (use classes do FontAwesome):
fa-truck-fast, fa-truck, fa-box, fa-boxes-stacked, fa-location-dot, fa-route, fa-clock, 
fa-check, fa-check-circle, fa-times-circle, fa-exclamation-triangle, fa-arrow-right,
fa-shield, fa-phone, fa-envelope, fa-whatsapp, fa-users, fa-chart-line, fa-lightbulb,
fa-star, fa-cog, fa-warehouse, fa-dollar-sign, fa-trophy, fa-globe

Regras:
1. Crie entre 5-7 slides
2. Use linguagem profissional mas acessível
3. Primeiro slide deve ser uma capa impactante
4. Último slide deve ser CTA com contatos
5. Seja específico sobre logística e transporte
6. Use dados e informações relevantes quando possível
7. RETORNE APENAS O JSON, SEM TEXTO ADICIONAL`;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }]
            })
        });

        if (!response.ok) {
            throw new Error('Erro na API do Gemini. Verifique sua API Key.');
        }

        const data = await response.json();
        const generatedText = data.candidates[0].content.parts[0].text;

        // Extrair JSON do texto (caso venha com markdown)
        let jsonText = generatedText.trim();
        if (jsonText.startsWith('```json')) {
            jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
        } else if (jsonText.startsWith('```')) {
            jsonText = jsonText.replace(/```\n?/g, '');
        }

        const result = JSON.parse(jsonText);

        // Aplicar slides gerados
        slides = result.slides.map((slide, index) => ({
            ...slide,
            id: generateId(),
            bgColor: slide.bgColor || '#0D1B2A',
            textColor: slide.textColor || '#FFFFFF'
        }));

        renderSlidesEditor();
        updatePreview();

        document.getElementById('ai-loading').classList.add('hidden');
        showToast(`${slides.length} slides gerados com sucesso!`);

    } catch (error) {
        console.error('Erro ao gerar com IA:', error);
        document.getElementById('ai-loading').classList.add('hidden');
        showToast('Erro ao gerar conteúdo: ' + error.message, 'error');
    }
}

// ============================================
// EXPORTAÇÃO DE IMAGENS
// ============================================

async function downloadImages() {
    const filename = document.getElementById('export-filename').value || 'marilog_post';
    const loading = document.getElementById('export-loading');
    loading.classList.remove('hidden');

    try {
        const format = document.getElementById('post-format').value;
        const bgColor = document.getElementById('bg-color').value;
        const bgPattern = document.getElementById('bg-pattern').value;

        if (slides.length === 1) {
            // Download único
            const slideHtml = getTemplate(slides[0], bgColor, bgPattern, format);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = slideHtml;
            document.body.appendChild(tempDiv);

            const element = tempDiv.firstChild;

            const blob = await htmlToImage.toBlob(element, {
                quality: 1,
                pixelRatio: 2,
                cacheBust: true
            });

            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}.png`;
            link.click();

            document.body.removeChild(tempDiv);
            URL.revokeObjectURL(url);

            showToast('Imagem baixada com sucesso!');
        } else {
            // Download múltiplo como ZIP
            await downloadCarousel();
            return;
        }

    } catch (error) {
        console.error('Erro ao exportar:', error);
        showToast('Erro ao exportar imagem: ' + error.message, 'error');
    } finally {
        loading.classList.add('hidden');
    }
}

async function downloadCarousel() {
    const filename = document.getElementById('export-filename').value || 'marilog_post';
    const loading = document.getElementById('export-loading');
    loading.classList.remove('hidden');

    try {
        const format = document.getElementById('post-format').value;
        const bgColor = document.getElementById('bg-color').value;
        const bgPattern = document.getElementById('bg-pattern').value;

        const zip = new JSZip();

        for (let i = 0; i < slides.length; i++) {
            const slide = slides[i];
            const slideHtml = getTemplate(slide, bgColor, bgPattern, format);

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = slideHtml;
            document.body.appendChild(tempDiv);

            const element = tempDiv.firstChild;

            const blob = await htmlToImage.toBlob(element, {
                quality: 1,
                pixelRatio: 2,
                cacheBust: true
            });

            const slideNumber = String(i + 1).padStart(2, '0');
            zip.file(`${filename}_${slideNumber}.png`, blob);

            document.body.removeChild(tempDiv);

            // Feedback de progresso
            showToast(`Processando slide ${i + 1}/${slides.length}...`, 'info');
        }

        const zipBlob = await zip.generateAsync({ type: 'blob' });
        saveAs(zipBlob, `${filename}_carrossel.zip`);

        showToast('Carrossel exportado com sucesso!');

    } catch (error) {
        console.error('Erro ao exportar carrossel:', error);
        showToast('Erro ao exportar carrossel: ' + error.message, 'error');
    } finally {
        loading.classList.add('hidden');
    }
}

// ============================================
// ATALHOS DE TECLADO
// ============================================

document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + S = Salvar
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveProject();
    }

    // Ctrl/Cmd + E = Exportar
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        downloadImages();
    }

    // Ctrl/Cmd + N = Novo slide
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        addSlide();
    }
});

// ============================================
// INICIALIZAÇÃO
// ============================================

window.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Gerador de Posts Marilog carregado!');

    // Carregar API key salva
    const savedApiKey = localStorage.getItem('gemini_api_key');
    if (savedApiKey) {
        document.getElementById('gemini-api-key').value = savedApiKey;
    }

    // Renderizar editor e preview inicial
    renderSlidesEditor();
    updatePreview();

    showToast('Bem-vindo ao Gerador de Posts Marilog! 🚛', 'info');
});

console.log('✅ JavaScript Parte 3 carregado (Preview, AI e Export)');
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9d485f56fa3baf68","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
